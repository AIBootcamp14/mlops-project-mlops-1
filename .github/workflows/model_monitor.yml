name: Model Monitoring and Retraining

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  check_and_retrain:
    runs-on: ubuntu-latest
    outputs:
      retrain_needed: ${{ steps.monitor_step.outputs.retrain_needed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install --no-cache-dir -r requirements.txt --break-system-packages

      - name: Download NLTK data
        run: python -m nltk.downloader punkt wordnet stopwords
      
      - name: Check for existing models artifact
        id: check_artifact
        uses: actions/github-script@v6
        with:
          script: |
            const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const modelsArtifact = artifacts.artifacts.find(artifact => artifact.name === 'models');
            if (modelsArtifact) {
              console.log('âœ… models artifact found.');
              core.setOutput('artifact_exists', 'true');
            } else {
              console.log('âš ï¸ No models artifact found. Forcing a retrain.');
              core.setOutput('artifact_exists', 'false');
            }

      - name: Download latest model artifact
        if: steps.check_artifact.outputs.artifact_exists == 'true'
        uses: actions/download-artifact@v4
        with:
          name: models
          path: models

      - name: Monitor model performance
        id: monitor_step
        if: steps.check_artifact.outputs.artifact_exists == 'true'
        run: |
          # GITHUB_OUTPUTì— ì¬í•™ìŠµ í•„ìš” ì—¬ë¶€ ë³€ìˆ˜ë¥¼ ì €ì¥
          retrain_output=$(python src/model_monitor.py)
          echo "$retrain_output" >> $GITHUB_OUTPUT
      
      - name: Check for initial build
        if: steps.check_artifact.outputs.artifact_exists == 'false'
        id: initial_build
        run: |
          echo "retrain_needed=true" >> $GITHUB_OUTPUT

      - name: Retrain and Deploy if needed
        if: steps.monitor_step.outputs.retrain_needed == 'true' || steps.initial_build.outputs.retrain_needed == 'true'
        run: |
          echo "ğŸ”¥ ì¬í•™ìŠµ ë° ë°°í¬ë¥¼ ìœ„í•œ CI/CD ì›Œí¬í”Œë¡œìš°ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤."
          # ì´ ë¶€ë¶„ì—ì„œ main_ci_cd.yml ì›Œí¬í”Œë¡œìš°ë¥¼ ì¬ì‹¤í–‰í•˜ê±°ë‚˜, 
          # ci, deploy ì‘ì—…ì„ ì§ì ‘ ìˆ˜í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          # ì˜ˆ: github cli ì‚¬ìš©
          # gh workflow run main_ci_cd.yml
